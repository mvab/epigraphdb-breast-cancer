---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

```{r setup I, eval=TRUE, echo=F}
knitr::opts_chunk$set(eval = TRUE, include = T, message = F, warning = F, comment="")
```

```{r include=F}
library(tidyverse)
library(TwoSampleMR)
library(flextable)
library(readxl)

source("../helper_functions.R")
source("explore_MR-EvE_app/functions.R")
source("mr_related_functions.R")


set_flextable_defaults(big.mark = " ", 
  font.size = 10, theme_fun = theme_vanilla,
  padding.bottom = 6, 
  padding.top = 6,
  padding.left = 6,
  padding.right = 6,
  background.color = "#EFEFEF")

```


```{r  set_params,  include=F}
main <- "ukb-a-34"
main_lit <- "ieu-a-1096"
trait_name <- extract_instruments(main) %>% split_exposure() %>% pull(exposure) %>% unique()
trait_name <- "Childhood body size"
#

#main <- "prot-a-710"
#main_lit <- "prot-a-710"
#trait_name <- extract_instruments(main) %>% split_exposure() %>% pull(exposure) %>% unique()

#main <- "ukb-d-30770_irnt"
#main_lit <- "ukb-d-30770_irnt"
#trait_name <- extract_instruments(main) %>% split_exposure() %>% pull(exposure) %>% unique()



case_terms<- read_csv("../02_literature_related/literature_outputs/sankey_terms_storage/lit_terms_childhood_obesity.csv")#%>% filter(value != 'cardiotrophin 1')

all =T
pos = T
neg = T
```

**Report for: `r trait_name`**


### MR results

```{r echo =F}
path <- c("mr_evidence_outputs/mr_subtypes/all_data_with_sens_filters.xlsx")
mr_df<- path %>% 
  excel_sheets() %>% 
  set_names() %>% 
  map(read_excel, path = path)

mr_results<-tibble()
for (i in names(mr_df)){
  tmp<- mr_df[[i]] %>% filter(id.exposure == main)
  mr_results <- bind_rows(mr_results, tmp)
}
mr_results <- mr_results %>% select(exposure, id.outcome, nsnp, OR_CI, `egger_intercept_less_than_0.05`, `Q_pval_less_than_0.05`) 

mr_results %>% kable_it()
```

### Lit spaces 

```{r, include =F}
lit_df<- read_tsv("../02_literature_related/literature_outputs/traits_marked_for_lit_analysis.tsv")

lit_trait <-lit_df %>% filter(id == main_lit)

```

Literature triples: `r lit_trait$unique_triples`

Literature pairs: `r lit_trait$unique_pairs`


### Literaure terms - GWAS - SNPs

```{r  cache=TRUE, include=F}

lit_terms_df<- case_terms %>% select(value, gwas.id, gwas.name) %>% drop_na() %>% distinct() 

for (i in 1:length(lit_terms_df$gwas.id)){
  y <- extract_instruments(lit_terms_df$gwas.id[i])
  if (is.null(y)){
    lit_terms_df$instruments[i] <- 0
  } else{
    
    if ( NA %in% y$eaf.exposure) {
      lit_terms_df$instruments[i] <- 0
    } else {
      lit_terms_df$instruments[i] <- dim(y)[1]
    }
 
  }
}
ids <- lit_terms_df %>% filter(instruments > 0 ) %>% filter(!gwas.id %in% c("prot-a-81", "prot-a-1102") )%>% pull(gwas.id)

colnames(lit_terms_df) <- c("lit_term", 'gwas.id', "gwas.name", "nSNPs")

#lit_terms_df %>%  write_csv("../02_literature_related/literature_outputs/sankey_terms_storage/lit_terms_cardiotrophin1_w_inst.csv")
```

```{r , include=F}
# for reporting
lit_terms <- length(unique(case_terms$value)) # all lit terms
unique_lit_terms<- length(unique(lit_terms_df$lit_term)) #  lit terms with gwas data
gwas_with_inst_total <-lit_terms_df %>% filter(nSNPs > 0) %>% pull(lit_term) %>% length()
gwas_with_inst_unique <-lit_terms_df %>% filter(nSNPs > 0) %>% pull(lit_term) %>% unique() %>% length()

# terms with at least 1 inst 

lit_terms_df %>% filter(nSNPs >= 1) %>% select(lit_term, gwas.name) %>% distinct() 
```

All lit terms: `r lit_terms`

Lit terms with GWAS: `r unique_lit_terms` (table below)

Lit terms with GWAS with inst: `r gwas_with_inst_total` (highlighted with orange)

Lit terms with GWAS with inst (unique): `r gwas_with_inst_unique`


```{r echo=F}


ft<-flextable(lit_terms_df)
ft<-width(ft, j = c(1,3), width=3)


ft %>% bg(
  ., i = ~ nSNPs > 0, 
  j = colnames(lit_terms_df), 
  bg = "#F2B748", part = "body")
```





```{r , include=F}
res_df_all<-data_frame()
res_df_pos<-data_frame()
res_df_neg<-data_frame()

## do MR for all gwas from the list; for outputs that were set
if (all){ res_df_all <- bind_rows(lapply(ids, do_MR, 'all'))  }
if (pos){ res_df_pos <- bind_rows(lapply(ids, do_MR, 'ER+'))  }
if (neg){ res_df_neg <- bind_rows(lapply(ids, do_MR, 'ER-'))  }

redone_MR_full <- bind_rows(res_df_all,res_df_pos, res_df_neg)

# split into MR and sens and save
redone_MR <- redone_MR_full %>% 
              select(-starts_with('egger_intercept'), -starts_with('Q'))

##
redoneMR_tidy <- redone_MR %>%  
  select(exposure, id.exposure , id.outcome, OR_CI, effect_direction , nsnp, method) %>% 
  filter(effect_direction != "overlaps null") %>% 
  filter(method %in% c('Inverse variance weighted', 'Wald ratio')) %>% arrange(id.outcome) %>% 
  filter(id.exposure != "finn-b-E4_OBESITY")

#redoneMR_tidy %>%  select(1:2) %>% distinct() %>% View() # for adding T

```


Traits that have effect on breast cancer (N = `r length(unique(redoneMR_tidy$exposure))`):

`r paste0(unique(redoneMR_tidy$exposure), collapse = ", ") `

```{r echo=F}
ft<-flextable(redoneMR_tidy)
ft<-width(ft, j = c(1,3,7,4), width=3)
ft
```



```{r , include=F, cache =TRUE}

outcomes <- unique(redoneMR_tidy$id.outcome) 
total_res <- data_frame()


for (bc_out in outcomes){
  
  results_list <- list()
  
  interm_list <- redoneMR_tidy %>% filter(id.outcome == bc_out) %>% filter(id.exposure !=  'prot-a-2363') %>% pull(id.exposure)
  
  for (interm in interm_list){
  
    x<- bind_rows(
      quick_mr(exp = main, out = interm) %>% select(3:4, OR_CI, effect_direction, or) %>% mutate(effect = "EM - as med"),# as mediator
      quick_mr(exp = interm, out = main) %>% select(3:4, OR_CI, effect_direction, or) %>% mutate(effect = "ME - as conf"),# as confounder
      quick_mr(exp = main, out = bc_out) %>% select(3:4, OR_CI, effect_direction, or) %>% mutate(effect = "EO"),# main to out
      quick_mr(exp = interm, out = bc_out) %>% select(3:4, OR_CI, effect_direction, or) %>% mutate(effect = "MO"),# interm to out
      quick_mvmr(exp1 = main, exp2 = interm, out = bc_out) %>% select(1:2, OR_CI, effect_direction, or) %>% mutate(effect = "direct") 
      ) %>%
      mutate(test = paste0(interm, " / ", bc_out) ) %>% 
      select(test, exposure, everything()) %>% 
      mutate(outcome = gsub("(Combined Oncoarray; iCOGS; GWAS meta analysis)", "", outcome, fixed = T)) 
    
      # try to record if main trair effect is attenuates or reduced; attempt to do fir 5 and 6 rows - the output differs because mvmr output alphabetically sorted
      trait_name <-  x$exposure[1]
      if (x$exposure[5] == trait_name){
         x <- x %>%
           mutate(attenuates_effect = ifelse(x$effect_direction[1] != 'overlaps null' & x$effect_direction[5] == 'overlaps null',T, F ) ) %>% 
           mutate(reduces_effect = ifelse(x$or[1] >  x$or[5] , F, T ) ) 
      } else if (x$exposure[6] == trait_name){
        x <- x %>% 
          mutate(attenuates_effect = ifelse(x$effect_direction[1] != 'overlaps null' & x$effect_direction[6] == 'overlaps null',T, F ) ) %>% 
          mutate(reduces_effect = ifelse(x$or[1] >  x$or[6] , F, T ) ) 
      }
    
    results_list[[interm]] <- x
  }  
  
  all_res <- bind_rows(results_list)
  total_res <-bind_rows(total_res, all_res)
  
}


total_res_out<- transform(total_res,group =as.numeric(factor(test)))
total_res_out<- total_res_out %>% select(group, everything(), -test) %>% arrange(group)
```


### MR valiadation results for traits subset from literature intermediates list

Only for the traits that have effect on breast cancer:

`r unique(redoneMR_tidy$exposure)`


```{r echo =F}
total_res_out <- as_grouped_data(x = total_res_out, groups = c("group"), columns = NULL)
ft<-flextable(total_res_out)
ft<-width(ft, j = c(2,3,4,6), width=2)
ft
```



### Review of mediators from MR-EvE

```{r,  include=F}

med_conf_table <- readxl::read_excel("mr_evidence_outputs/med-conf-table_upd.xlsx", sheet = main)

meds_table <- med_conf_table %>% filter(type== 'mediator') %>% 
  select(exposure.trait, outcome.id, med.id, med.trait, r1.OR_CI_val, r2.OR_CI_val, r3.OR_CI_val) 

unique_meds <- length(unique(meds_table$med.trait))

```

Mediators from MR-EvE: `r unique_meds`

Table of EM, MO, MO effects (validated)

`r paste0(unique(meds_table$med.trait), collapse = ", ") `


```{r, echo=F}
colnames(meds_table) <- c('exposure',	'outcome'	,	'mediator.id', 'mediator',	"exposure -> mediator",	'exposure -> outcome',	'mediator -> outcome')

ft<-flextable(meds_table)
ft<-width(ft, j = c(1,4,5,6,7), width=2)
ft
```


```{r include=F, cache=T}

trait = unique(meds_table$exposure)

outcomes <- unique(meds_table$outcome) 

disrupted_by_all <- data_frame()
disrupts_all <- data_frame()


for (bc_out in outcomes){

  interm_list<-med_conf_table %>%  filter(med.id %in% meds_table$mediator.id) %>% filter(outcome.id == bc_out) %>%  pull(med.id)
  
  df<-tibble()
  for ( interm in interm_list){
    tmp<- quick_mvmr(exp1 = main, exp2 = interm, out = bc_out) %>% 
      select(1:2, OR_CI, effect_direction, nsnp) %>%
      mutate(effect = "direct", interm = interm) 
    df<- bind_rows(df, tmp)
  }

  
  # list of interm where exp or/and interm overlaps null
  x<- df %>% filter(effect_direction == 'overlaps null') %>% pull(interm)
  
  # exposure disrupted by interm
  # returns disrupted exposure values
  disrupted_by <- df %>% filter(interm %in% x) %>% 
    filter(exposure == trait) %>% 
    filter(effect_direction == 'overlaps null') %>%
    arrange(exposure) %>% distinct()
  
  disrupted_by<- disrupted_by %>% left_join(med_conf_table %>%
                               filter(outcome.id == bc_out) %>%
                               select( med.id,med.trait, r2.OR_CI_val), by = c('interm' = 'med.id')) %>% 
    rename(disrupter = med.trait, OR_CI_direct = OR_CI, OR_CI_total = r2.OR_CI_val) %>% 
    select(exposure,  outcome, OR_CI_total, disrupter,  OR_CI_total, OR_CI_direct)
  
  disrupted_by_all <- bind_rows(disrupted_by_all, disrupted_by) 
  
  
  # exposure disrupts interm
  # return disrupted interm values
  disrupts<- df %>% filter(interm %in% x) %>%
    filter(exposure != trait) %>% 
    filter(effect_direction == 'overlaps null') %>% 
    rename(disrupts_this = exposure) %>% mutate(exposure = trait) %>% 
    select(exposure, disrupts_this, everything()) %>% distinct() 
  
  disrupts<- disrupts %>% left_join(med_conf_table %>% 
                           filter(outcome.id == bc_out) %>% 
                           select( med.id, r3.OR_CI_val, r3.nsnp_val), by = c('interm' = 'med.id')) %>% 
    rename(OR_CI_direct = OR_CI, OR_CI_total = r3.OR_CI_val) %>% 
    select(exposure,outcome, OR_CI_total,  disrupts_this,  OR_CI_direct)
  
  disrupts_all <- bind_rows(disrupts_all, disrupts)
  
  
}

```

Traits that attenuate `r trait_name` effect: `r length(unique(disrupted_by_all$disrupter))` 

`r unique(disrupted_by_all$disrupter)`

`r trait_name` attenuates the effect of traits: `r length(unique(disrupts_all$disrupts_this))`

`r unique(disrupts_all$disrupts_this)`

####  MVMR results 

```{r echo=F}
disrupted_by_all<- disrupted_by_all %>% distinct()
ft<-flextable(disrupted_by_all)
ft<-width(ft, j = c(1:5), width=1.5)
ft<-width(ft, j = 4, width=2.5)
ft
```

```{r echo =F}
#disrupts_all<- disrupts_all %>% distinct()
#ft<-flextable(disrupts_all)
#ft<-width(ft, j = c(1:5), width=1.5)
#ft<-width(ft, j = 4, width=2.5)
#ft
```





























### Optional: sensitivity analysis with female only data

#### MVMR

```{r echo =F,  eval =F}


#id2_tophits_file  <- "igf_tophits.tsv"
#id2_gwas_file <- "igf_GWAS_tidy_outcome.txt.gz"
library(vroom)
id2_tophits_file  <-  vroom("/Users/ny19205/OneDrive - University of Bristol/Documents - OneDrive/Mini-project2/01_Data/GWAS_tophits/early_bmi_adj_tophits.tsv")

id2_gwas_file <- vroom("/Users/ny19205/OneDrive - University of Bristol/Documents - OneDrive/Mini-project2/01_Data/GWAS_results_tidy/early_bmi_adj_GWAS_tidy_outcome.txt.gz")


# to try: redoneMR_tidy

#igf1_meds <-c('ukb-b-16881', 'ukb-a-269','prot-b-20','ieu-b-4869','finn-b-E4_OBESITY','ieu-a-974')

med_list <- unique(redoneMR_tidy$id.exposure)

all_res <- tibble()

for (i in med_list){
  x1 <- mvmr_mixed_sources(id1 = i,
                   outcome.id = 'ieu-a-1126',
                   id2_tophits_file,
                   id2_gwas_file)
  
  x2 <- mvmr_mixed_sources(id1 = i,
                   outcome.id = 'ieu-a-1127',
                   id2_tophits_file,
                   id2_gwas_file)
  x3 <- mvmr_mixed_sources(id1 = i,
                   outcome.id = 'ieu-a-1128',
                   id2_tophits_file,
                   id2_gwas_file)
  
  
  all_res<- bind_rows(all_res, x1, x2, x3)
}



```

#### trait -> mediator

```{r echo =F,  eval =F}
interm_list <- redoneMR_tidy %>% filter(id.outcome == bc_out) %>% filter(id.exposure !=  'prot-a-2363') %>% pull(id.exposure) %>% unique()
#instruments<-read_tsv("/Users/ny19205/OneDrive - University of Bristol/Documents - OneDrive/Mini-project2/01_Data/GWAS_tophits/igf_tophits.tsv")
instruments<-read_tsv("/Users/ny19205/OneDrive - University of Bristol/Documents - OneDrive/Mini-project2/01_Data/GWAS_tophits/early_bmi_adj_tophits.tsv")

out_df<-tibble()

for (i in interm_list){
  
  out <- extract_outcome_data(
    snps = instruments$SNP,
    outcome = i)

  harmonised<- harmonise_data(exposure_dat = instruments, 
                              outcome_dat = out)
  
  res_early <- TwoSampleMR::mr(harmonised, method_list = c('mr_ivw')) %>% 
    split_outcome() %>% 
    split_exposure() %>% 
    generate_odds_ratios() %>% 
    select(exposure, outcome, starts_with("or"))
  
  out_df<-bind_rows(out_df, res_early)
  
}

out_df %>% kable_it()

```
#### mediator -> trait

```{r echo =F,  eval =F}
# opposite dir

interm_list <- redoneMR_tidy %>% filter(id.outcome == bc_out) %>% filter(id.exposure !=  'prot-a-2363') %>% pull(id.exposure) %>% unique()

#gwas<- vroom::vroom("/Users/ny19205/OneDrive - University of Bristol/Documents - OneDrive/Mini-project2/01_Data/GWAS_results_tidy/igf_GWAS_tidy_outcome.txt.gz")
gwas<- vroom::vroom("/Users/ny19205/OneDrive - University of Bristol/Documents - OneDrive/Mini-project2/01_Data/GWAS_results_tidy/early_bmi_adj_GWAS_tidy_outcome.txt.gz")



out_df2<-tibble()

for (i in interm_list){
  
  instruments <- extract_instruments(i)
  
  out <- gwas %>% 
        filter(SNP %in%instruments$SNP)

  harmonised<- harmonise_data(exposure_dat = instruments, 
                              outcome_dat = out)
  
  res_early <- TwoSampleMR::mr(harmonised, method_list = c('mr_ivw')) %>% 
    split_outcome() %>% 
    split_exposure() %>% 
    generate_odds_ratios() %>% 
    select(exposure, outcome, starts_with("or"))
  
  out_df2<-bind_rows(out_df2, res_early)
  
}

out_df2 %>% kable_it()


```

