---
title: "Process traits"
output: html_notebook
---

```{r message=F}
library(dplyr)
library(readr)
library(tidyr)
library(stringr)

library(TwoSampleMR)

```


```{r, message = FALSE, include=F}
rm(dat)
dat <-  read_tsv("mr_evidence_outputs/tidy_traits_by_cat.tsv") %>%  # made in explore_mr_results.Rmd
        # update exposure categories 
        create_exposure_categories() %>%  filter(exposure_cat != 'other')
  

dat %>% select(exposure_cat, exposure.trait, exposure.id) %>% distinct() %>% filter(exposure_cat == 'Other biomarkers') %>% View()

dat %>% select(exposure_cat, exposure.trait, exposure.id) %>% distinct() %>%count(exposure_cat) 
```

#### Method for finding interesting things

```{r}

traits_for_follow_up <- function(input) {
  # this is a method to select traits that  have effect in 2/3 of main dataset in a subtype
  

  ids <- input %>% pull(exposure.id) %>% unique()
  res <- list()
  
  for (i in ids){
    # pre-set of results to use for selection
    input_subset_array <- input %>% 
      filter(chip %in% c('Meta', "OncArray",  "iCOG2017")) %>% 
      select(exposure.id, exposure.trait, exposure_cat, outcome.id, outcome, mr.pval, starts_with('or'),
             effect_direction, mr.method, mr.moescore) %>%
      filter(exposure.id == i) 
    
    if (dim(input_subset_array)[1] != 0) {
      # continue if these outcomes (arrays) are present
    
      # drop results that 'overlap null' for all selected outcomes
      effect <-input_subset_array %>% pull(effect_direction) %>% unique()
      
      if (length(effect) == 1 & "overlaps null" %in% effect){
            # Skipping this trait
            i_name <- input %>% filter(exposure.id == i) %>% pull(exposure.trait) %>% unique()
            print(paste0(i," / ", i_name))

      } else {
        #get counts per BC type
        counts_per_type <- 
          input_subset_array %>% 
          group_by(outcome) %>% 
          janitor::tabyl(outcome, effect_direction) %>% 
          as_tibble()
       
        
        
        # identify cases when traits have >=2 effects in positive or negative direction
        if ('positive' %in% colnames(counts_per_type) & 'negative' %in% colnames(counts_per_type)){
          dir <- 'both'
          tmp <- bind_rows(
                    counts_per_type %>% filter(positive >= 2),
                    counts_per_type %>% filter(negative >= 2)) %>% 
                 distinct()
          
          if (sum(tmp$negative) == 0){dir <- 'positive'
          } else if (sum(tmp$positive) == 0){dir <- 'negative'
          } else if (sum(tmp$negative) > sum(tmp$positive) ){dir <- 'negative'
          } else if (sum(tmp$negative) < sum(tmp$positive)){dir <- 'positive'}
          
          
        } else if ('positive' %in% colnames(counts_per_type)){
          tmp <- counts_per_type %>% filter(positive >=  2)
          dir <- 'positive'
          
        } else if ('negative' %in% colnames(counts_per_type)){
          tmp <-  counts_per_type %>% filter(negative >=2 )
          dir <- 'negative'
        }
    
        if (dim(tmp)[1] != 0) {
          # collect results for trait in a vector and keep in a list
          trait_tmp<-c(unique(input_subset_array$exposure_cat), unique(input_subset_array$exposure.id),  unique(input_subset_array$exposure.trait), 0,0,0, dir)
          names(trait_tmp)<-c('exposure_cat', 'id', 'trait', 'all', "ER+", "ER-", 'dir')
            
          if ("Breast cancer (all)" %in% tmp$outcome){ trait_tmp[["all"]] <- 1 }
          if ("ER+ postmeno"        %in% tmp$outcome){ trait_tmp[["ER+"]] <- 1 }
          if ("ER- premeno"         %in% tmp$outcome){ trait_tmp[["ER-"]] <- 1 }
          res[[unique(input_subset_array$exposure.id)]] <- trait_tmp
        }
        
      }
      if (exists("tmp")){ rm(tmp) }
      
    }
  }
  
  
  #list to df
  out<- bind_rows(res) 
  return(out)
}
```

```{r}

all_cats<-tibble() # run once
cats <- dat %>% pull(exposure_cat) %>% unique()

for (i in cats){
  print(paste0("Doing ", i))
  
  input <- dat %>% filter(exposure_cat == i)
  
  # run for each category input
  u <- traits_for_follow_up(input)
  
  all_cats<-bind_rows(all_cats, u) %>% distinct()
}

all_cats %>% select(exposure_cat, trait, id) %>% distinct() %>% count(exposure_cat)

dim(all_cats) # 314   7

write_tsv(all_cats, "mr_evidence_outputs/trait_for_followup.tsv")
```

```{r}
## summary MOE methods for that data that we keep

dat %>% 
  filter(exposure.id %in% all_cats$id) %>% 
  filter(chip %in% c('Meta', 'iCOG2017', 'OncArray')) %>% 
  select(exposure.id, outcome.id, mr.method) %>% 
  distinct() %>% 
  count(mr.method) %>% arrange(-n) %>% 
  mutate(pct =  round(n/sum(n)*100, 2)) 

```


```{r}

do_MR <- function(trait, bc_type){
  
  if       (bc_type == 'all'){bc.id <- 'ieu-a-1126'
  }else if (bc_type == 'ER+'){bc.id <- 'ieu-a-1127'
  }else if (bc_type == 'ER-'){bc.id <- 'ieu-a-1128'}
  
  instruments <- extract_instruments(trait)
  out <- extract_outcome_data(snps = instruments$SNP,
                              outcome = bc.id)
  harmonised<- harmonise_data(exposure_dat = instruments, 
                              outcome_dat = out)
  #mr
  res <- mr(harmonised, method_list=c('mr_ivw','mr_wald_ratio','mr_egger_regression','mr_weighted_median')) %>% 
    split_outcome() %>% 
    split_exposure() %>% 
    generate_odds_ratios() %>% 
    mutate(OR_CI = paste0(round(or,3), " [",round(or_lci95,3) ,":",round(or_uci95,3), "]")) %>% 
    mutate(effect_direction = ifelse(or_lci95 > 1 & or_uci95 >= 1, 'positive',
                              ifelse(or_lci95 < 1 & or_uci95 <= 1, 'negative', 'overlaps null'))) 
  # sensitivity
  if (dim(harmonised)[1]>1){
    res_sens <-
      full_join(mr_pleiotropy_test(harmonised),
              mr_heterogeneity(harmonised, method_list=c("mr_egger_regression", "mr_ivw"))) %>% 
    split_outcome() %>%
    split_exposure() %>% 
    rename(egger_intercept_pval = pval,
            egger_intercept_se = se)
  } else {
    # making dummy sens anlysis table as a placeholder
    res_sens <- res %>% select(id.exposure, id.outcome, exposure, outcome, nsnp) %>% distinct() %>% mutate(method = "NO SENSITIVITY")
  }
  
  # join mr and sens in one table
  out <- full_join(res, res_sens)

 return( out) 
} 
```

```{r}
## validate results by redoing MR + sensitivity tests

all_cats<-read_tsv("mr_evidence_outputs/trait_for_followup.tsv")

exp_help_names <- dat %>% 
  select(exposure_name=exposure, id.exposure=exposure.id, exposure_cat) %>% 
  distinct()

## MR -- doing all outcomes validaton, even if mr-eve had sign result only for one or two types
ids <-all_cats %>% pull(id)
res_df_all <- bind_rows(lapply(ids, do_MR, 'all')) 
res_df_pos <- bind_rows(lapply(ids, do_MR, 'ER+')) 
res_df_neg <- bind_rows(lapply(ids, do_MR, 'ER-'))

redone_MR_full <- bind_rows(res_df_all,res_df_pos,res_df_neg) %>% left_join(exp_help_names)

# split into MR and sens and save
redone_MR <- redone_MR_full %>% 
              select(-starts_with('egger_intercept'), -starts_with('Q'))
redone_MR_sens <- redone_MR_full %>% 
              select(id.exposure, id.outcome, exposure, outcome, method, nsnp,
                     starts_with('egger_intercept'), starts_with('Q'), exposure_name, exposure_cat) %>% 
              filter(method != 'Weighted median')


## category update tmp fix (needed unless rerun MR)
#redone_MR<- redone_MR %>%rename(exposure.trait=exposure, exposure.id = id.exposure ) %>%
#  create_exposure_categories() %>%  filter(exposure_cat != 'other') %>% 
#  select(-exposure ) %>% 
#  rename(id.exposure = exposure.id , exposure = exposure.trait) 
write_tsv(redone_MR,      "mr_evidence_outputs/redone_MR_fulloutput.tsv")


## category update tmp fix (needed unless rerun MR)
#redone_MR_sens<- redone_MR_sens %>%rename(exposure.trait=exposure, exposure.id = id.exposure ) %>%
#  create_exposure_categories() %>%  filter(exposure_cat != 'other') %>% 
#  select(-exposure ) %>% 
#  rename(id.exposure = exposure.id , exposure = exposure.trait) 
write_tsv(redone_MR_sens, "mr_evidence_outputs/redone_MR_fulloutput_sens.tsv")


##
redoneMR_tidy <- redone_MR %>%  
  select(exposure, id.exposure ,exposure_name, id.outcome, OR_CI, effect_direction , nsnp, method, exposure_cat) %>% 
  filter(effect_direction != "overlaps null") %>% 
  filter(method %in% c('Inverse variance weighted', 'Wald ratio'))

redoneMR_tidy%>%  select(exposure, id.exposure, exposure_cat) %>% distinct() %>% count(exposure_cat)#total
redoneMR_tidy%>% filter(id.outcome == 'ieu-a-1127') %>%  select(exposure, id.exposure, exposure_cat) %>% distinct() %>% count(exposure_cat) # selected outcome

#write_tsv(redoneMR_tidy, "mr_evidence_outputs/trait_manual_ivw.tsv") #### OLD NAME
write_tsv(redoneMR_tidy, "mr_evidence_outputs/redone_MR_subsetoutput_ivw.tsv")



# create wide form of results to view by subtype
redone_MR <- read_tsv("mr_evidence_outputs/redone_MR_fulloutput.tsv")

redone_wide <- redone_MR %>%
  select(id.outcome, id.exposure,exposure, exposure_name, effect_direction, method, exposure_cat) %>% 
  filter(method %in% c('Inverse variance weighted', 'Wald ratio') )%>% 
  mutate(effect_dir_binary = case_when(effect_direction == 'negative' ~ -1, 
                                       effect_direction == 'positive' ~  1,
                                       effect_direction == 'overlaps null' ~  0)) %>% 
  select(-effect_direction, -method) %>% 
  pivot_wider(names_from = id.outcome, values_from = effect_dir_binary)
 


```

```{r}
library(eulerr)

s4 <- list(`All` = redone_wide %>% filter(`ieu-a-1126` != 0) %>% pull(id.exposure) %>% sort(),
           `ER+` = redone_wide %>% filter(`ieu-a-1127` != 0) %>% pull(id.exposure)%>% sort(),
           `ER-` = redone_wide %>% filter(`ieu-a-1128` != 0) %>% pull(id.exposure)%>% sort())
plot(euler(s4, shape = "ellipse"), quantities = TRUE)

```

#
#
NEXT, in other script `mr_results_for_bcac_subtypes.Rmd` we create MR results for those traits in subtypes
#
#


## Load results from subtype analysis

```{r message =F}

res_subtypes <- read_tsv("mr_evidence_outputs/mr_subtypes/all_traits_MR_vs_BCAC2020.tsv")

## category update 
res_subtypes <- res_subtypes %>% 
  rename(exposure.trait=exposure, exposure.id = id.exposure ) %>%
  create_exposure_categories() %>%  filter(exposure_cat != 'other') %>% 
  select(-exposure ) %>% 
  rename(id.exposure = exposure.id , exposure = exposure.trait) 

#res_subtypes_for_count <- res_subtypes %>% 
#  select(exposure, id.exposure , outcome, OR_CI, effect_direction , nsnp, method, exposure_cat) %>% 
#  filter(effect_direction != "overlaps null") %>% 
#  filter(method %in% c('Inverse variance weighted', 'Wald ratio')) 
#
#counts_by_outcome <- list(
#  total = res_subtypes_for_count %>% select(id.exposure, exposure_cat) %>% distinct() %>%  count(exposure_cat) %>% rename(total=n) %>% 
#    column_to_rownames('exposure_cat') %>% t() %>% as_data_frame(),
#  all = res_subtypes_for_count %>% filter(outcome =="Breast cancer BCAC 2020")%>% count(exposure_cat) %>% rename(all=n)%>%
#    column_to_rownames('exposure_cat') %>% t() %>% as_data_frame(),
#  lumA = res_subtypes_for_count %>% filter(outcome =="LuminalA ER+PR+HER-")%>% count(exposure_cat) %>% rename(lumA=n)%>% 
#    column_to_rownames('exposure_cat') %>% t() %>% as_data_frame(),
#  lumB1 = res_subtypes_for_count %>% filter(outcome =="LuminalB1 ER+PR+HER-")%>% count(exposure_cat) %>% rename(lumB1=n)%>% 
#    column_to_rownames('exposure_cat') %>% t() %>% as_data_frame(),
#  lumB2 = res_subtypes_for_count %>% filter(outcome =="LuminalB2 ER+PR+HER+")%>% count(exposure_cat) %>% rename(lumB2=n)%>% 
#    column_to_rownames('exposure_cat') %>% t() %>% as_data_frame(),
#  her2 = res_subtypes_for_count %>% filter(outcome =="HER2-enriched ER-PR-HER+")%>% count(exposure_cat) %>% rename(her2=n)%>% 
#    column_to_rownames('exposure_cat') %>% t() %>% as_data_frame(),
#  tnbc = res_subtypes_for_count %>% filter(outcome =="TNBC ER-PR-HER-")%>% count(exposure_cat) %>% rename(tnbc=n)%>% 
#    column_to_rownames('exposure_cat') %>% t() %>% as_data_frame())
#
#counts_by_outcome_df <- bind_rows(counts_by_outcome) %>% t() %>% as.data.frame() %>% rownames_to_column('exposure_cat') %>% mutate(across(everything(), ~replace_na(.x, 0))) 
#colnames(counts_by_outcome_df)[2:8] <- names(counts_by_outcome)
#write_tsv(counts_by_outcome_df, "mr_evidence_outputs/mr_subtypes/counts_by_exposure_cat.tsv")

res_subtypes_wide<- res_subtypes %>% 
  select(outcome, id.exposure,exposure,  effect_direction, method) %>% 
  filter(method %in% c('Inverse variance weighted', 'Wald ratio') )%>% 
  mutate(effect_dir_binary = case_when(effect_direction == 'negative' ~ -1, 
                                       effect_direction == 'positive' ~  1,
                                       effect_direction == 'overlaps null' ~  0)) %>% 
  select(-effect_direction, -method) %>% 
  pivot_wider(names_from = outcome, values_from = effect_dir_binary)

 

#merge subtypes and validation
merged <- left_join(redone_wide, 
                    res_subtypes_wide) %>% 
          left_join(exp_help_names) %>% 
          mutate(label = paste0("(", id.exposure, ") ", exposure_name )) %>% 
          select(exposure_cat, label, everything()) 


write_tsv(merged, "mr_evidence_outputs/trait_manual_ivw_subtypes_merged.tsv")
```


### Sensitivity analysis review


### PLAN


# 1, >2 snps (so that sens tests are possible)
# 2. IVW must have effect 
# 3. egger and median must hve same effect direction
# 4. one egger or median also has to be signidicant

#. egger intecent must be low ~0.002 + large Pval =OK
#  flag low Q pval - is Q high? 



```{r}
# add sensitivity analysis cols 

add_sensitivity_cols <- function(main_results, sens_results, outcome_name){
  
  
  # main results
  all <- main_results %>% mutate(low_SNP_num = ifelse(nsnp < 5 , T, F))
  type <- all %>% filter(id.outcome == outcome_name)
  type_filtered<- type  %>% 
                 filter(method %in%  c('Inverse variance weighted', "Wald ratio")  & effect_direction != "overlaps null") 
  print(paste( outcome_name, ":::", length(unique(type_filtered$id.exposure)), "/",  length(unique(type$id.exposure)) ) )

  type <- type %>% filter(id.exposure %in% type_filtered$id.exposure) 
  
  ##count alt MR success
  effect_count <- type %>% 
    filter(effect_direction != "overlaps null") %>% 
    group_by( exposure, id.exposure) %>% count( exposure, id.exposure) %>% 
    rename(num_mr_effect = n) %>% ungroup()
  
  type <- type %>%
    left_join(effect_count) %>%
    filter(method %in%  c('Inverse variance weighted', "Wald ratio"))
  
  # sens results 
  sens_type <- sens_results %>% 
        filter(id.outcome == outcome_name) %>% 
        filter(method ==  'Inverse variance weighted')

  sens_type <- sens_type %>%   
    mutate(`egger_intercept_less_than_0.05` = ifelse(egger_intercept < 0.05, T, F) ) %>%  # pleio 1?
    mutate(`egger_intercept_pval_more_than_0.05` = ifelse(egger_intercept_pval > 0.05, T, F) ) %>%  # pleio 2?
    mutate(`Q_pval_less_than_0.05` = ifelse(Q_pval < 0.05, T, F) )  # heterogeniety 

  
  # merge into one df
  merged<- left_join(type, sens_type) %>% 
          select(everything(), -low_SNP_num, low_SNP_num, -num_mr_effect, num_mr_effect)

}


## old outcomes
main_results <- read_tsv("mr_evidence_outputs/redone_MR_fulloutput.tsv")
sens_results <- read_tsv("mr_evidence_outputs/redone_MR_fulloutput_sens.tsv")

res_w_sens <- list()

outcomes1<- c('ieu-a-1126', 'ieu-a-1127', 'ieu-a-1128')

for (outcome_name in outcomes1){
  res_w_sens[[outcome_name]] <- add_sensitivity_cols(main_results, sens_results, outcome_name)
}

# new outcomes <- will add to the same list

main_results <- read_tsv("mr_evidence_outputs/mr_subtypes/all_traits_MR_vs_BCAC2020.tsv") %>%  mutate(id.outcome = outcome)
sens_results <- read_tsv("mr_evidence_outputs/mr_subtypes/all_traits_sensMR_vs_BCAC2020.tsv") %>%  mutate(id.outcome = outcome)

outcomes2 <- unique(main_results$id.outcome)

for (outcome_name in outcomes2){
  res_w_sens[[outcome_name]] <- add_sensitivity_cols(main_results, sens_results, outcome_name)
}

# "ieu-a-1126 ::: 117 / 314"
# "ieu-a-1127 ::: 126 / 314"
# "ieu-a-1128 ::: 61 / 314"
# "Breast cancer BCAC 2020 ::: 108 / 313"
# "Luminal A: ER+PR+HER- ::: 104 / 313"
# "Luminal B1: ER+PR+HER- ::: 37 / 313"
# "Luminal B2: ER+PR+HER+ ::: 31 / 313"
# "HER2-enriched: ER-PR-HER+ ::: 42 / 313"
# "TNBC: ER-PR-HER- ::: 52 / 313"
# "TNBC BRCA1: ER-PR-HER- ::: 37 / 314"


writexl::write_xlsx(res_w_sens, "mr_evidence_outputs/mr_subtypes/all_data_with_sens_filters.xlsx")


x %>% count(`egger_intercept_less_than_0.05`, `egger_intercept_pval_more_than_0.05`)

x %>%  filter(`egger_intercept_less_than_0.05` == F & `egger_intercept_pval_more_than_0.05` == T) %>% View()

x %>%  filter(`egger_intercept_less_than_0.05` == T & `egger_intercept_pval_more_than_0.05` == F) %>% View()

  
  
  

```







































x %>% count(`egger_intercept_less_than_0.05`, `egger_intercept_pval_more_than_0.05`)

x %>%  filter(`egger_intercept_less_than_0.05` == F & `egger_intercept_pval_more_than_0.05` == T) %>% View()

x %>%  filter(`egger_intercept_less_than_0.05` == T & `egger_intercept_pval_more_than_0.05` == F) %>% View()

```{r}
### variaous viz attempts

heatmap(data, Colv = NA, Rowv = NA, scale="column", col = coul, xlab="variable", ylab="car", main="heatmap")


only_ER_neg <- merged %>%
  filter(`ieu-a-1128` ==1 & `Basal-like TNBC: ER-PR-HER-` ==1 & `BRCA1_CIMBA TNBC: ER-PR-HER-` ==1) 


only_ER_pos <- merged %>%
  filter(`ieu-a-1127` ==1 & `Luminal B1: ER+PR+HER-` ==1 & `Luminal B2: ER+PR+HER+` ==1 & `Luminal A: ER+PR+HER-`==1 ) 

only_HER_pos <- merged %>%
  filter(`Luminal B2: ER+PR+HER+` ==1 & `HER2-enriched: ER-PR-HER+` ==1) 


# only in old BCAC
merged %>%
  filter(`ieu-a-1126` ==1) %>% 
  filter_at(vars(-`ieu-a-1126`,-exposure_cat, -label, -id.exposure, -exposure_name ), all_vars(. == 0))%>% View()

merged %>%
  filter(`ieu-a-1126` ==1 | `ieu-a-1128` ==1 | `ieu-a-1127` ==1 ) %>% 
  filter_at(vars(-contains('ieu'),-exposure_cat, -label, -id.exposure, -exposure_name ), all_vars(. == 0))%>% View()
# same but count
merged %>%
  filter(`ieu-a-1126` ==1 | `ieu-a-1128` ==1 | `ieu-a-1127` ==1 ) %>% 
  filter_at(vars(-contains('ieu'),-exposure_cat, -label, -id.exposure, -exposure_name ), all_vars(. == 0))%>% count(exposure_cat)


merged_lipids<- merged %>% filter(exposure_cat %in% c("Proteins", "Metabolites", "Other biomarkers")) %>% 
          filter(grepl("LDL|HDL|cholest|trigl", exposure_name, ignore.case = T))

write_tsv(merged_lipids, "mr_evidence_outputs/trait_manual_ivw_subtypes_merged_LIPIDS.tsv")


not_lipids<- merged %>% filter(exposure_cat %in% c("Proteins", "Metabolites", "Other biomarkers")) %>% 
          filter(!grepl("LDL|HDL|cholest|trigl", exposure_name, ignore.case = T))

write_tsv(not_lipids, "mr_evidence_outputs/trait_manual_ivw_subtypes_merged_NOTLIPIDS.tsv")

```


```{r}
##### NEXT: need to decide how to use this info to make any further decisions
# https://cran.r-project.org/web/packages/dendextend/vignettes/Cluster_Analysis.html

library(dendextend)

merged <- read_tsv("mr_evidence_outputs/trait_manual_ivw_subtypes_merged.tsv") %>% 
  filter(!exposure_cat %in% c("Proteins", "Metabolites", "Other biomarkers"))

merged <- read_tsv("mr_evidence_outputs/trait_manual_ivw_subtypes_merged.tsv") %>% 
  filter(exposure_cat %in% c("Proteins", "Metabolites", "Other biomarkers")) %>% 
  filter(!grepl("LDL|HDL|cholest|trigl", exposure_name, ignore.case = T)) #%>% 
  #mutate(exposure_cat = ifelse(grepl("HDL", label), "HDL", "not HDL"))
  

merged<- merged %>% mutate(overall = case_when(`ieu-a-1126` ==1 | `ieu-a-1128` ==1 | `ieu-a-1127` ==1 ~ 1,
                                       `ieu-a-1126` ==-1 | `ieu-a-1128` ==-1 | `ieu-a-1127` ==-1 ~ 2 ))

#merged_data <- merged %>% select(5:14)

merged_data <- merged %>% select("Basal-like TNBC: ER-PR-HER-",#"BRCA1_CIMBA TNBC: ER-PR-HER-",  
                                 "HER2-enriched: ER-PR-HER+" , "Luminal A: ER+PR+HER-" ,
                                 "Luminal B2: ER+PR+HER+" , "Luminal B1: ER+PR+HER-"  )

merged_data <- merged %>% select("ieu-a-1126" , "ieu-a-1127" ,"ieu-a-1128" ) %>% 
   mutate(sum = rowSums(across(where(is.numeric)))) %>% 
   mutate(direction = case_when(sum < 0 ~ "negative",
                          sum > 0 ~ "positive",
                          TRUE ~ "no effect")) %>% select(-sum)

merged_data <- merged %>% select("ieu-a-1126" , "ieu-a-1127" ,"ieu-a-1128" , "exposure_cat")


merged_data <- merged %>% select( "ieu-a-1127" ,"ieu-a-1128",
                                  "Basal-like TNBC: ER-PR-HER-","BRCA1_CIMBA TNBC: ER-PR-HER-",  
                                 "HER2-enriched: ER-PR-HER+" , "Luminal A: ER+PR+HER-" ,
                                 "Luminal B2: ER+PR+HER+" , "Luminal B1: ER+PR+HER-" )

merged_data <- merged %>% select("ieu-a-1126" ,  "Breast cancer (overall BCAC 2020)")


d <- dist(merged_data) # method="man" # is a bit better
hc <- hclust(d, method = "complete")
dat <- levels(unclass(factor(merged %>% pull(1))))

dend <- as.dendrogram(hc)
# order it the closest we can to the order of the observations:
dend <- rotate(dend, 1:dim(merged_data)[1])

# for conveniet viewing
merged_data$exposure_name <- merged %>% pull(exposure_name)

# Color the branches based on the clusters:
dend <- color_branches(dend, k=1, col= 'black')

#mypal <- RColorBrewer::brewer.pal(10,"Paired")[c(2,6, 4)]
#mypal <- c("black","black","black" )

mypal <- c( "#4D9221", "#C51B7D") #  green pink
#mypal <- c("orange", "purple")

# Manually match the labels, as much as possible, to the real classification of the flowers:
labels_colors(dend) <-
   mypal[sort_levels_values(as.numeric(unclass(factor(merged_data %>% pull(exposure_cat))))[order.dendrogram(dend)])]


# We shall add the flower type to the labels:
labels(dend) <- paste(as.character(merged %>% pull(4))[order.dendrogram(dend)])

# We hang the dendrogram a bit:
dend <- hang.dendrogram(dend,hang_height=0.1)
# reduce the size of the labels:
# dend <- assign_values_to_leaves_nodePar(dend, 0.5, "lab.cex")
dend <- set(dend, "labels_cex", 0.6)
# And plot:
par(mar = c(2.5,0.5,2,25))
plot(dend, 
     horiz =  TRUE,  nodePar = list(cex = .007))
#mytitle = "Clustered based on"
#mysubtitle = paste0(rev(colnames(merged_data))[-1], collapse=", ")
mtext(side=3, line=0.8, at=1, adj=1, cex=1.2, mytitle)
#mtext(side=3, line=-0.2, at=1, adj=1, cex=0.9, mysubtitle) # meta
mtext(side=3, line=-0.2, at=-2.5, adj=1, cex=0.6, mysubtitle)

legend("topleft", legend = dat, fill = mypal)


# circular diagram 
library(circlize)
par(mar = rep(0,4))
circlize_dendrogram(dend)


## with heatmap

# scaled_iris2 <- iris2 %>% as.matrix %>% scale
# library(gplots)


merged_data<-merged_data %>% tibble::column_to_rownames('exposure_name')

gplots::heatmap.2(as.matrix(merged_data), 
          main = "Heatmap",
          srtCol = 20,
          dendrogram = "row",
          Rowv = dend,
          Colv = "NA", # this to make sure the columns are not ordered
          trace="none",          
          margins =c(5,10),      
          key.xlab = "Cm",
          denscol = "grey",
          density.info = "density",
          #RowSideColors = rev(labels_colors(dend)), # to add nice colored strips        
          col = brewer.pal(n=7, name = "PiYG")
         )

```

