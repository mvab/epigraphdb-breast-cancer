---
title: "Process traits"
output: html_notebook
---

```{r message=F}
library(dplyr)
library(readr)
library(tidyr)
library(stringr)

library(TwoSampleMR)

source("explore_MR-EvE_app/functions.R")

source("mr_related_functions.R")
```


```{r, message = FALSE, include=F}
rm(dat)
dat <-  read_tsv("mr_evidence_outputs/tidy_traits_by_cat.tsv") %>%  # made in explore_mr_results.Rmd
        # update exposure categories 
        create_exposure_categories() %>%  filter(exposure_cat != 'other')
  

dat %>% select(exposure_cat, exposure.trait, exposure.id) %>% distinct() %>% filter(exposure_cat == 'Other biomarkers') %>% View()

dat %>% select(exposure_cat, exposure.trait, exposure.id) %>% distinct() %>%count(exposure_cat) 
```





```{r}

all_cats<-tibble() # run once
cats <- dat %>% pull(exposure_cat) %>% unique()

for (i in cats){
  cat('\n')
  print(paste0("Doing ", i))
  
  input <- dat %>% filter(exposure_cat == i)
  
  # run for each category input
  u <- traits_for_follow_up(input)
  
  all_cats<-bind_rows(all_cats, u) %>% distinct()
}

all_cats %>% select(exposure_cat, trait, id) %>% distinct() %>% count(exposure_cat)

dim(all_cats) # 312   7

write_tsv(all_cats, "mr_evidence_outputs/trait_for_followup.tsv")
```

```{r}
## summary MOE methods for that data that we keep

dat %>% 
  filter(exposure.id %in% all_cats$id) %>% 
  filter(chip %in% c('Meta', 'iCOG2017', 'OncArray')) %>% 
  select(exposure.id, outcome.id, mr.method) %>% 
  distinct() %>% 
  count(mr.method) %>% arrange(-n) %>% 
  mutate(pct =  round(n/sum(n)*100, 2)) 

```


```{r}
## validate results by redoing MR + sensitivity tests

all_cats<-read_tsv("mr_evidence_outputs/trait_for_followup.tsv")

exp_help_names <- dat %>% # from the first chunk
  select('exposure_name'='exposure', 'id.exposure'='exposure.id', 'exposure_cat') %>% 
  distinct()

## MR -- doing all outcomes validaton, even if mr-eve had sign result only for one or two types
ids <-all_cats %>% pull(id)
res_df_all <- bind_rows(lapply(ids, do_MR, 'all')) 
res_df_pos <- bind_rows(lapply(ids, do_MR, 'ER+')) 
res_df_neg <- bind_rows(lapply(ids, do_MR, 'ER-'))

redone_MR_full <- bind_rows(res_df_all,res_df_pos,res_df_neg) %>% left_join(exp_help_names)

# split into MR and sens and save
redone_MR <- redone_MR_full %>% 
              select(-starts_with('egger_intercept'), -starts_with('Q'))
redone_MR_sens <- redone_MR_full %>% 
              select(id.exposure, id.outcome, exposure, outcome, method, nsnp,
                     starts_with('egger_intercept'), starts_with('Q'), exposure_name, exposure_cat) %>% 
              filter(method != 'Weighted median')


## category update tmp fix (needed unless rerun MR)
#redone_MR<- redone_MR %>%rename(exposure.trait=exposure, exposure.id = id.exposure ) %>%
#  create_exposure_categories() %>%  filter(exposure_cat != 'other') %>% 
#  select(-exposure ) %>% 
#  rename(id.exposure = exposure.id , exposure = exposure.trait) 
write_tsv(redone_MR,      "mr_evidence_outputs/redone_MR_fulloutput.tsv")


## category update tmp fix (needed unless rerun MR)
#redone_MR_sens<- redone_MR_sens %>%rename(exposure.trait=exposure, exposure.id = id.exposure ) %>%
#  create_exposure_categories() %>%  filter(exposure_cat != 'other') %>% 
#  select(-exposure ) %>% 
#  rename(id.exposure = exposure.id , exposure = exposure.trait) 
write_tsv(redone_MR_sens, "mr_evidence_outputs/redone_MR_fulloutput_sens.tsv")


##
redoneMR_tidy <- redone_MR %>%  
  select(exposure, id.exposure ,exposure_name, id.outcome, OR_CI, effect_direction , nsnp, method, exposure_cat) %>% 
  filter(effect_direction != "overlaps null") %>% 
  filter(method %in% c('Inverse variance weighted', 'Wald ratio'))

redoneMR_tidy%>%  select(exposure, id.exposure, exposure_cat) %>% distinct() %>% count(exposure_cat)#total
redoneMR_tidy%>% filter(id.outcome == 'ieu-a-1127') %>%  select(exposure, id.exposure, exposure_cat) %>% distinct() %>% count(exposure_cat) # selected outcome

#write_tsv(redoneMR_tidy, "mr_evidence_outputs/trait_manual_ivw.tsv") #### OLD NAME
write_tsv(redoneMR_tidy, "mr_evidence_outputs/redone_MR_subsetoutput_ivw.tsv")



# create wide form of results to view by subtype
redone_MR <- read_tsv("mr_evidence_outputs/redone_MR_fulloutput.tsv")

redone_wide <- redone_MR %>%
  select(id.outcome, id.exposure,exposure, exposure_name, effect_direction, method, exposure_cat) %>% 
  filter(method %in% c('Inverse variance weighted', 'Wald ratio') )%>% 
  mutate(effect_dir_binary = case_when(effect_direction == 'negative' ~ -1, 
                                       effect_direction == 'positive' ~  1,
                                       effect_direction == 'overlaps null' ~  0)) %>% 
  select(-effect_direction, -method) %>% 
  pivot_wider(names_from = id.outcome, values_from = effect_dir_binary)
 

redone_MR %>% filter(method %in% c('Inverse variance weighted', 'Wald ratio') ) %>% 
  arrange(pval) %>% mutate(qval = p.adjust(pval, method = "BH")) %>% View()


```

```{r}
library(eulerr)

s4 <- list(`All` = redone_wide %>% filter(`ieu-a-1126` != 0) %>% pull(id.exposure) %>% sort(),
           `ER+` = redone_wide %>% filter(`ieu-a-1127` != 0) %>% pull(id.exposure)%>% sort(),
           `ER-` = redone_wide %>% filter(`ieu-a-1128` != 0) %>% pull(id.exposure)%>% sort())
plot(euler(s4, shape = "ellipse"), quantities = TRUE)

```

#
#
NEXT, in other script `mr_results_for_bcac_subtypes.Rmd` we create MR results for those traits in subtypes
#
#


## Load results from subtype analysis

```{r message =F}

res_subtypes <- read_tsv("mr_evidence_outputs/mr_subtypes/all_traits_MR_vs_BCAC2020.tsv")

## category update 
res_subtypes <- res_subtypes %>% 
  rename(exposure.trait=exposure, exposure.id = id.exposure ) %>%
  create_exposure_categories() %>%  filter(exposure_cat != 'other') %>% 
  select(-exposure ) %>% 
  rename(id.exposure = exposure.id , exposure = exposure.trait) 

#res_subtypes_for_count <- res_subtypes %>% 
#  select(exposure, id.exposure , outcome, OR_CI, effect_direction , nsnp, method, exposure_cat) %>% 
#  filter(effect_direction != "overlaps null") %>% 
#  filter(method %in% c('Inverse variance weighted', 'Wald ratio')) 
#
#counts_by_outcome <- list(
#  total = res_subtypes_for_count %>% select(id.exposure, exposure_cat) %>% distinct() %>%  count(exposure_cat) %>% rename(total=n) %>% 
#    column_to_rownames('exposure_cat') %>% t() %>% as_data_frame(),
#  all = res_subtypes_for_count %>% filter(outcome =="Breast cancer BCAC 2020")%>% count(exposure_cat) %>% rename(all=n)%>%
#    column_to_rownames('exposure_cat') %>% t() %>% as_data_frame(),
#  lumA = res_subtypes_for_count %>% filter(outcome =="LuminalA ER+PR+HER-")%>% count(exposure_cat) %>% rename(lumA=n)%>% 
#    column_to_rownames('exposure_cat') %>% t() %>% as_data_frame(),
#  lumB1 = res_subtypes_for_count %>% filter(outcome =="LuminalB1 ER+PR+HER-")%>% count(exposure_cat) %>% rename(lumB1=n)%>% 
#    column_to_rownames('exposure_cat') %>% t() %>% as_data_frame(),
#  lumB2 = res_subtypes_for_count %>% filter(outcome =="LuminalB2 ER+PR+HER+")%>% count(exposure_cat) %>% rename(lumB2=n)%>% 
#    column_to_rownames('exposure_cat') %>% t() %>% as_data_frame(),
#  her2 = res_subtypes_for_count %>% filter(outcome =="HER2-enriched ER-PR-HER+")%>% count(exposure_cat) %>% rename(her2=n)%>% 
#    column_to_rownames('exposure_cat') %>% t() %>% as_data_frame(),
#  tnbc = res_subtypes_for_count %>% filter(outcome =="TNBC ER-PR-HER-")%>% count(exposure_cat) %>% rename(tnbc=n)%>% 
#    column_to_rownames('exposure_cat') %>% t() %>% as_data_frame())
#
#counts_by_outcome_df <- bind_rows(counts_by_outcome) %>% t() %>% as.data.frame() %>% rownames_to_column('exposure_cat') %>% mutate(across(everything(), ~replace_na(.x, 0))) 
#colnames(counts_by_outcome_df)[2:8] <- names(counts_by_outcome)
#write_tsv(counts_by_outcome_df, "mr_evidence_outputs/mr_subtypes/counts_by_exposure_cat.tsv")

res_subtypes_wide<- res_subtypes %>% 
  select(outcome, id.exposure,exposure,  effect_direction, method) %>% 
  filter(method %in% c('Inverse variance weighted', 'Wald ratio') )%>% 
  mutate(effect_dir_binary = case_when(effect_direction == 'negative' ~ -1, 
                                       effect_direction == 'positive' ~  1,
                                       effect_direction == 'overlaps null' ~  0)) %>% 
  select(-effect_direction, -method) %>% 
  pivot_wider(names_from = outcome, values_from = effect_dir_binary)

 
# testing MTC
res_subtypes %>% 
  filter(method %in% c('Inverse variance weighted', 'Wald ratio') ) %>% 
  arrange(pval) %>% mutate(qval = p.adjust(pval, method = "BH")) 


#merge subtypes and validation 
merged <- left_join(redone_wide, 
                    res_subtypes_wide) %>% 
          left_join(exp_help_names) %>% 
          mutate(label = paste0("(", id.exposure, ") ", exposure_name )) %>% 
          select(exposure_cat, label, everything()) 


write_tsv(merged, "mr_evidence_outputs/trait_manual_ivw_subtypes_merged.tsv")
```


### Sensitivity analysis review


### PLAN


# 1, >2 snps (so that sens tests are possible)
# 2. IVW must have effect 
# 3. egger and median must hve same effect direction
# 4. one egger or median also has to be signidicant

#. egger intecent must be low ~0.002 + large Pval =OK
#  flag low Q pval - is Q high? 



```{r}

## old outcomes
main_results <- read_tsv("mr_evidence_outputs/redone_MR_fulloutput.tsv")
sens_results <- read_tsv("mr_evidence_outputs/redone_MR_fulloutput_sens.tsv")

res_w_sens <- list()

outcomes1<- c('ieu-a-1126', 'ieu-a-1127', 'ieu-a-1128')

for (outcome_name in outcomes1){
  res_w_sens[[outcome_name]] <- add_sensitivity_cols(main_results, sens_results, outcome_name)
}

# new outcomes <- will add to the same list

main_results <- read_tsv("mr_evidence_outputs/mr_subtypes/all_traits_MR_vs_BCAC2020.tsv") %>%  mutate(id.outcome = outcome)
sens_results <- read_tsv("mr_evidence_outputs/mr_subtypes/all_traits_sensMR_vs_BCAC2020.tsv") %>%  mutate(id.outcome = outcome)

outcomes2 <- unique(main_results$id.outcome)

for (outcome_name in outcomes2){
  res_w_sens[[outcome_name]] <- add_sensitivity_cols(main_results, sens_results, outcome_name)
}

names(res_w_sens) <- c("All. BCAC 2017", "ER+. BCAC 2017 ", "ER-. BCAC 2017", 
                       "All. BCAC 2020", "Luminal A. BCAC 2020","Luminal B1. BCAC 2020", 
                                     "Luminal B2. BCAC 2020",  "HER2-enriched. BCAC 2020", "TNBC. BCAC 2020" )

res_w_sens <-res_w_sens[names(res_w_sens)[1:9]]# drop seconf TNBC


# "ieu-a-1126 ::: 117 / 314"
# "ieu-a-1127 ::: 126 / 314"
# "ieu-a-1128 ::: 61 / 314"
# "Breast cancer BCAC 2020 ::: 108 / 313"
# "Luminal A: ER+PR+HER- ::: 104 / 313"
# "Luminal B1: ER+PR+HER- ::: 37 / 313"
# "Luminal B2: ER+PR+HER+ ::: 31 / 313"
# "HER2-enriched: ER-PR-HER+ ::: 42 / 313"
# "TNBC: ER-PR-HER- ::: 52 / 313"
# "TNBC BRCA1: ER-PR-HER- ::: 37 / 314"


writexl::write_xlsx(res_w_sens, "mr_evidence_outputs/mr_subtypes/all_data_with_sens_filters.xlsx")




x %>% count(`egger_intercept_less_than_0.05`, `egger_intercept_pval_more_than_0.05`)

x %>%  filter(`egger_intercept_less_than_0.05` == F & `egger_intercept_pval_more_than_0.05` == T) %>% View()

x %>%  filter(`egger_intercept_less_than_0.05` == T & `egger_intercept_pval_more_than_0.05` == F) %>% View()

  
  
  
bind_rows(res_w_sens) %>% filter(exposure_cat == 'Proteins' | exposure == 'Albumin') %>%  filter(nsnp >=3)  %>% View()

bind_rows(res_w_sens) %>% filter(exposure_cat == 'Proteins' | exposure == 'Albumin') %>%  filter(nsnp >=3) %>% count(exposure,nsnp,  sort=T)

```








```{r}
### Subsetting to traits from MR that have enough lit space

lit_space_sizes <- read_tsv("../02_literature_related/literature_outputs/traits_marked_for_lit_analysis.tsv")

mr_results_df <- read_tsv("mr_evidence_outputs/trait_manual_ivw_subtypes_merged.tsv")

emply_lit_spaces <- lit_space_sizes %>% filter(lit_analysis ==1 & lit_space_size == 0 ) 
excluded_from_lit_query  <- lit_space_sizes %>% filter(lit_analysis ==0 ) 


mr_results_sub <- mr_results_df %>% 
  filter(!id.exposure %in% emply_lit_spaces$id) %>% 
  tibble::column_to_rownames('id.exposure') %>%
  select(5:13) %>% 
  mutate(across(everything(), ~replace(., . ==  0 , NA)))%>% 
  filter(if_any(everything(), ~ !is.na(.))) %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>% 
  tibble::rownames_to_column('id.exposure') %>% 
  left_join(mr_results_sub %>% select(id.exposure, exposure, exposure_cat)) %>% 
  select(exposure_cat, id.exposure, exposure, 
          "BCAC 2017"="ieu-a-1126",
          "BCAC 2020"="Breast cancer BCAC 2020",
          "ER+" = "ieu-a-1127" ,
          "ER-" = "ieu-a-1128" ,
          everything() ) %>% 
  filter(exposure_cat != 'Lipids')

# add protein names
protein_names <- read_csv("mr_evidence_outputs/protein_names.csv", col_names = F) %>% rename(name = X1, gene = X2)
mr_results_sub<- mr_results_sub %>% left_join(protein_names, by = c('exposure'='name')) 

# add lit size
mr_results_sub<- mr_results_sub %>% left_join(lit_space_sizes %>% select(id, unique_triples, unique_pairs), by =c("id.exposure"= 'id'))
  

write_tsv(mr_results_sub, "mr_evidence_outputs/trait_manual_ivw_subtypes_merged_Litspaces_available.tsv")

  

```

```{r}
# finding which proteins already appear in breast cancer lit space
common_terms_bc <- read_tsv("../02_literature_related/literature_outputs/breast_cancer_terms.tsv", col_names = T)

mr_results_sub %>%  filter(exposure_cat %in% c('Proteins', 'Metabolites')) %>% 
  mutate(in_bc_space = ifelse(gene %in% common_terms_bc$name | exposure %in% common_terms_bc$name, 1,0))%>%
  filter(in_bc_space ==1) %>% 
  left_join(common_terms_bc, by =c('exposure'='name')) %>% 
  left_join(common_terms_bc, by =c('gene'='name')) %>% 
  mutate(size_in_bc_space = coalesce(size.x, size.y)) %>% 
  select(-size.x, -size.y) %>% 
  View()
```






```{r}
# ad hoc check
cand_list<-read_tsv("../01_MR_related/mr_evidence_outputs/candidate_list.tsv", col_names = F) %>% distinct()

mr_results_sub %>% filter(exposure %in% cand_list$X1) %>% View()

```





























x %>% count(`egger_intercept_less_than_0.05`, `egger_intercept_pval_more_than_0.05`)

x %>%  filter(`egger_intercept_less_than_0.05` == F & `egger_intercept_pval_more_than_0.05` == T) %>% View()

x %>%  filter(`egger_intercept_less_than_0.05` == T & `egger_intercept_pval_more_than_0.05` == F) %>% View()

```{r}
### variaous viz attempts

heatmap(data, Colv = NA, Rowv = NA, scale="column", col = coul, xlab="variable", ylab="car", main="heatmap")


only_ER_neg <- merged %>%
  filter(`ieu-a-1128` ==1 & `Basal-like TNBC: ER-PR-HER-` ==1 & `BRCA1_CIMBA TNBC: ER-PR-HER-` ==1) 


only_ER_pos <- merged %>%
  filter(`ieu-a-1127` ==1 & `Luminal B1: ER+PR+HER-` ==1 & `Luminal B2: ER+PR+HER+` ==1 & `Luminal A: ER+PR+HER-`==1 ) 

only_HER_pos <- merged %>%
  filter(`Luminal B2: ER+PR+HER+` ==1 & `HER2-enriched: ER-PR-HER+` ==1) 


# only in old BCAC
merged %>%
  filter(`ieu-a-1126` ==1) %>% 
  filter_at(vars(-`ieu-a-1126`,-exposure_cat, -label, -id.exposure, -exposure_name ), all_vars(. == 0))%>% View()

merged %>%
  filter(`ieu-a-1126` ==1 | `ieu-a-1128` ==1 | `ieu-a-1127` ==1 ) %>% 
  filter_at(vars(-contains('ieu'),-exposure_cat, -label, -id.exposure, -exposure_name ), all_vars(. == 0))%>% View()
# same but count
merged %>%
  filter(`ieu-a-1126` ==1 | `ieu-a-1128` ==1 | `ieu-a-1127` ==1 ) %>% 
  filter_at(vars(-contains('ieu'),-exposure_cat, -label, -id.exposure, -exposure_name ), all_vars(. == 0))%>% count(exposure_cat)


merged_lipids<- merged %>% filter(exposure_cat %in% c("Proteins", "Metabolites", "Other biomarkers")) %>% 
          filter(grepl("LDL|HDL|cholest|trigl", exposure_name, ignore.case = T))

write_tsv(merged_lipids, "mr_evidence_outputs/trait_manual_ivw_subtypes_merged_LIPIDS.tsv")


not_lipids<- merged %>% filter(exposure_cat %in% c("Proteins", "Metabolites", "Other biomarkers")) %>% 
          filter(!grepl("LDL|HDL|cholest|trigl", exposure_name, ignore.case = T))

write_tsv(not_lipids, "mr_evidence_outputs/trait_manual_ivw_subtypes_merged_NOTLIPIDS.tsv")

```


```{r}
##### NEXT: need to decide how to use this info to make any further decisions
# https://cran.r-project.org/web/packages/dendextend/vignettes/Cluster_Analysis.html

library(dendextend)

merged <- read_tsv("mr_evidence_outputs/trait_manual_ivw_subtypes_merged.tsv") %>% 
  filter(!exposure_cat %in% c("Proteins", "Metabolites", "Other biomarkers"))

merged <- read_tsv("mr_evidence_outputs/trait_manual_ivw_subtypes_merged.tsv") %>% 
  filter(exposure_cat %in% c("Proteins", "Metabolites", "Other biomarkers")) %>% 
  filter(!grepl("LDL|HDL|cholest|trigl", exposure_name, ignore.case = T)) #%>% 
  #mutate(exposure_cat = ifelse(grepl("HDL", label), "HDL", "not HDL"))
  

merged<- merged %>% mutate(overall = case_when(`ieu-a-1126` ==1 | `ieu-a-1128` ==1 | `ieu-a-1127` ==1 ~ 1,
                                       `ieu-a-1126` ==-1 | `ieu-a-1128` ==-1 | `ieu-a-1127` ==-1 ~ 2 ))

#merged_data <- merged %>% select(5:14)

merged_data <- merged %>% select("Basal-like TNBC: ER-PR-HER-",#"BRCA1_CIMBA TNBC: ER-PR-HER-",  
                                 "HER2-enriched: ER-PR-HER+" , "Luminal A: ER+PR+HER-" ,
                                 "Luminal B2: ER+PR+HER+" , "Luminal B1: ER+PR+HER-"  )

merged_data <- merged %>% select("ieu-a-1126" , "ieu-a-1127" ,"ieu-a-1128" ) %>% 
   mutate(sum = rowSums(across(where(is.numeric)))) %>% 
   mutate(direction = case_when(sum < 0 ~ "negative",
                          sum > 0 ~ "positive",
                          TRUE ~ "no effect")) %>% select(-sum)

merged_data <- merged %>% select("ieu-a-1126" , "ieu-a-1127" ,"ieu-a-1128" , "exposure_cat")


merged_data <- merged %>% select( "ieu-a-1127" ,"ieu-a-1128",
                                  "Basal-like TNBC: ER-PR-HER-","BRCA1_CIMBA TNBC: ER-PR-HER-",  
                                 "HER2-enriched: ER-PR-HER+" , "Luminal A: ER+PR+HER-" ,
                                 "Luminal B2: ER+PR+HER+" , "Luminal B1: ER+PR+HER-" )

merged_data <- merged %>% select("ieu-a-1126" ,  "Breast cancer (overall BCAC 2020)")


d <- dist(merged_data) # method="man" # is a bit better
hc <- hclust(d, method = "complete")
dat <- levels(unclass(factor(merged %>% pull(1))))

dend <- as.dendrogram(hc)
# order it the closest we can to the order of the observations:
dend <- rotate(dend, 1:dim(merged_data)[1])

# for conveniet viewing
merged_data$exposure_name <- merged %>% pull(exposure_name)

# Color the branches based on the clusters:
dend <- color_branches(dend, k=1, col= 'black')

#mypal <- RColorBrewer::brewer.pal(10,"Paired")[c(2,6, 4)]
#mypal <- c("black","black","black" )

mypal <- c( "#4D9221", "#C51B7D") #  green pink
#mypal <- c("orange", "purple")

# Manually match the labels, as much as possible, to the real classification of the flowers:
labels_colors(dend) <-
   mypal[sort_levels_values(as.numeric(unclass(factor(merged_data %>% pull(exposure_cat))))[order.dendrogram(dend)])]


# We shall add the flower type to the labels:
labels(dend) <- paste(as.character(merged %>% pull(4))[order.dendrogram(dend)])

# We hang the dendrogram a bit:
dend <- hang.dendrogram(dend,hang_height=0.1)
# reduce the size of the labels:
# dend <- assign_values_to_leaves_nodePar(dend, 0.5, "lab.cex")
dend <- set(dend, "labels_cex", 0.6)
# And plot:
par(mar = c(2.5,0.5,2,25))
plot(dend, 
     horiz =  TRUE,  nodePar = list(cex = .007))
#mytitle = "Clustered based on"
#mysubtitle = paste0(rev(colnames(merged_data))[-1], collapse=", ")
mtext(side=3, line=0.8, at=1, adj=1, cex=1.2, mytitle)
#mtext(side=3, line=-0.2, at=1, adj=1, cex=0.9, mysubtitle) # meta
mtext(side=3, line=-0.2, at=-2.5, adj=1, cex=0.6, mysubtitle)

legend("topleft", legend = dat, fill = mypal)


# circular diagram 
library(circlize)
par(mar = rep(0,4))
circlize_dendrogram(dend)


## with heatmap

# scaled_iris2 <- iris2 %>% as.matrix %>% scale
# library(gplots)


merged_data<-merged_data %>% tibble::column_to_rownames('exposure_name')

gplots::heatmap.2(as.matrix(merged_data), 
          main = "Heatmap",
          srtCol = 20,
          dendrogram = "row",
          Rowv = dend,
          Colv = "NA", # this to make sure the columns are not ordered
          trace="none",          
          margins =c(5,10),      
          key.xlab = "Cm",
          denscol = "grey",
          density.info = "density",
          #RowSideColors = rev(labels_colors(dend)), # to add nice colored strips        
          col = brewer.pal(n=7, name = "PiYG")
         )

```

