---
title: "Explore traits with effect in at least one outcome"
output: html_notebook
---

```{r message=F}
library(dplyr)
library(readr)
library(tidyr)
library(stringr)
library(ggplot2)
library(plotly)
library(wesanderson)
library(RColorBrewer)
library(flextable)
library(TwoSampleMR)
source('functions.R')
```


```{r, message = FALSE, include=F}
rm(dat)
dat <- read_tsv("../query_results/bc_all_mr.tsv") %>% 
      # subset 
  filter(exposure.sex != 'Males') %>% 
  filter(outcome.id != 'ebi-a-GCST007236') %>% 
  # convert MR results to OR
  tidy_display_numbers()%>% 
  # deal ith al outcome related changes
  process_bc_outcomes() %>% 
  # create categories of exposure traits
  create_exposure_categories() %>% 
  add_exposure_labels()

```

```{r}
outcome_table<- dat %>% 
  mutate(case_percent = round(N_case/outcome.sample_size*100, 2)) %>% 
  select(outcome, outcome.id, outcome.sample_size, N_case, case_percent, chip, outcome.year, outcome.nsnp)%>% 
  mutate(chip=gsub("_","", chip)) %>% 
  distinct() %>%
  arrange(outcome, desc(outcome.sample_size)) %>% 
  rename(`sample_size`=outcome.sample_size)


set_flextable_defaults(big.mark = " ", 
  font.size = 10, theme_fun = theme_vanilla,
  padding.bottom = 6, 
  padding.top = 6,
  padding.left = 6,
  padding.right = 6,
  background.color = "#EFEFEF")

ft<-flextable(outcome_table)
ft<-width(ft, j = 1, width=1.5)
ft<-width(ft, j = 2, width=1.7)
ft


```

```{r}

exposure_table<- dat %>% 
  select(exposure_cat, exposure.trait) %>% 
  distinct() %>% 
  count(exposure_cat) %>% arrange(-n)


set_flextable_defaults(big.mark = " ", 
  font.size = 10, theme_fun = theme_vanilla,
  padding.bottom = 6, 
  padding.top = 6,
  padding.left = 6,
  padding.right = 6,
  background.color = "#EFEFEF")

ft<-flextable(exposure_table)
ft


```


```{r include=F}
ply<-plotly::ggplotly(p)
```



### Anthophometric traits

```{r fig.width=10}
input <- dat %>% filter(exposure_cat %in% c('antrophometric')) %>% 
    filter(!grepl("arm|leg|first child", exposure.trait, ignore.case = T))

p<-plot_bubble_plot(input)
ply<-plotly::ggplotly(p)
ply

p_gg<-plotly::plotly_build(p) # convert ggplot object to plotly
p_gg$layout$showlegend = "TRUE"

```



```{r fig.width=10}
input <- dat %>% filter(exposure_cat %in% c('antrophometric')) %>% 
    filter(!grepl("arm|leg|first child", exposure.trait, ignore.case = T)) %>% 
  filter(mr.moescore >= 0.8) 

p<-plot_bubble_plot(input)
ply<-plotly::ggplotly(p)
ply
```


```{r fig.width=10}
input <- dat %>% filter(exposure_cat %in% c('antrophometric')) %>% 
  
    filter(!grepl("arm|leg|first child", exposure.trait, ignore.case = T)) %>% 
  filter(mr.pval <= 10e-8)

p<-plot_bubble_plot(input)
ply<-plotly::ggplotly(p)
ply
```




Antrophometric by sub-class

```{r fig.width=10}
# waist/hip subset
input_sub <- input %>%  filter(grepl('hip|waist|trunk' , exposure.trait, ignore.case = T))
p<-plot_bubble_plot(input_sub)
ply<-plotly::ggplotly(p)
ply
```

```{r fig.width=10}
# body
input_sub <- input %>%  filter(grepl('body|obesity|mass|weight' , exposure.trait, ignore.case = T)) %>% 
                        filter(!grepl('birth' , exposure.trait, ignore.case = T)) 
p<-plot_bubble_plot(input_sub)
ply<-plotly::ggplotly(p)
ply
```

```{r fig.width=10}
# height 
input_sub <- input %>%  filter(grepl('height' , exposure.trait, ignore.case = T)) %>% 
                        filter(!grepl('birth' , exposure.trait, ignore.case = T)) 
p<-plot_bubble_plot(input_sub)
ply<-plotly::ggplotly(p)
ply
```

```{r fig.width=10}
# birth
input_sub <- input %>%  filter(grepl('birth' , exposure.trait, ignore.case = T)) 
                        #filter(!grepl('birth' , exposure.trait, ignore.case = T)) 
p<-plot_bubble_plot(input_sub)
ply<-plotly::ggplotly(p)
ply
```


### Activity

```{r fig.width=10, fig.height=5}
input <- dat %>% filter(exposure_cat %in% c('activity')) %>% 
              mutate(exposure = gsub("\\(eg.*)", "", exposure))
p<-plot_bubble_plot(input)
p
```

### Supplements / vitamins

```{r fig.width=10, fig.height=5}
input <- dat %>% filter(exposure_cat %in% c('vitamin')) 
p<-plot_bubble_plot(input)
p
```


### Reproductive traits

```{r fig.width=10, fig.height=3}
input <- dat %>% filter(exposure_cat %in%  c('reproductive')) %>% 
                mutate(exposure = gsub("\\(eg.*)", "", exposure))

input_sub<- input %>% filter(mr.pval < 10e-5)
p<-plot_bubble_plot(input)
p
```



### Metabolites


```{r fig.width=10, fig.height=3}
input <- dat %>% filter(exposure_cat %in%  c('metabolite_measures')) %>% 
        # only keeloin ivrn
        filter(!grepl("_raw",exposure.id))
p<-plot_bubble_plot(input)
p

test_list<-input %>%  filter(mr.pval < 10e-6) %>% 
                      #filter(mr.b > 0.01) %>%
                      pull(exposure.id) %>% unique()
length(test_list)

p<-plot_bubble_plot(input %>% filter(exposure.id %in% test_list))
ply<-plotly::ggplotly(p)

```


### Diet

```{r fig.width=10, fig.height=3}
input <- dat %>% filter(exposure_cat %in%  c('diet')) %>% 
        # only keeloin ivrn
        filter(!grepl("_raw",exposure.id)) %>% 
        filter(chip %in% c('Meta',
                            'OncArray',
                            'iCOG2017'))
p<-plot_bubble_plot(input)
p
```



### Protein measures

```{r fig.width=10, fig.height=3}
input <- dat %>% filter(exposure_cat %in%  c('protein_measures')) %>% 
        # only keeloin ivrn
        filter(!grepl("_raw",exposure.id)) %>% 
        arrange(exposure.trait)
dim(input)[1]/9
length(unique(input$exposure.trait))

p<-plot_bubble_plot(input[1:1000,])
p<-plot_bubble_plot(input[1000:2000,])
p

test_list<-input %>%  filter(mr.pval < 10e-8) %>% filter(mr.b > 0.01) %>% pull(exposure.id) %>% unique()
length(test_list)

p<-plot_bubble_plot(input %>% filter(exposure.id %in% test_list[1:60]))
p<-plot_bubble_plot(input %>% filter(exposure.id %in% test_list[61:131]))
ply<-plotly::ggplotly(p)

```

### Other biomarkers/compounds

```{r fig.width=10, fig.height=3}
input <- dat %>% filter(exposure_cat %in%  c('other_biomarkers')) %>% 
        # only keeloin ivrn
        filter(!grepl("_raw",exposure.id)) %>% 
        filter(chip %in% c('Meta',
                            'OncArray',
                            'iCOG2017'))
p<-plot_bubble_plot(input)
p
```

### Cell measurements

```{r fig.width=10, fig.height=3}
input <- dat %>% filter(exposure_cat %in%  c('cell_measures')) %>% 
        # only keeloin ivrn
        filter(!grepl("_raw",exposure.id))
p<-plot_bubble_plot(input)
p
```


### Sleep

```{r fig.width=10, fig.height=3}
input <- dat %>% filter(exposure_cat %in%  c('sleep_related'))
p<-plot_bubble_plot(input)
p
```




<br>

```{r, eval=F}
ply<-plotly::ggplotly(p)
ply
```


### Other
```{r fig.width=12, eval=F}
input <- dat %>% filter(exposure_cat %in% c('other')) %>% 
                filter(!grepl("inhaler", exposure))
p<-plot_heatmap(input)
p
```


```{r fig.width=15}
input <- dat %>% filter(exposure_cat %in% c('other')) %>% 
                filter(!grepl("inhaler", exposure))
p<-plot_bubble_plot(input)
p
```




### Drugs
```{r fig.width=12}
input <- dat %>% filter(exposure_cat %in% c('drugs')) 
p<-plot_bubble_plot(input)
p
```

### Disease
```{r fig.width=15}
input <- dat %>% filter(exposure_cat %in% c('disease')) 
p<-plot_bubble_plot(input)
p
```

### Education
```{r fig.width=15}
input <- dat %>% filter(exposure_cat %in% c('education')) 
p<-plot_bubble_plot(input)
p
```


### Alcohol & smoking
```{r fig.width=15}
input <- dat %>% filter(exposure_cat %in% c('alcohol', 'smoking')) %>% filter(!grepl('dehydrogenase', exposure.trait))
p<-plot_bubble_plot(input)
p
```


### Phycology
```{r fig.width=15}
input <- dat %>% filter(exposure_cat %in% c('psychology')) 
p<-plot_bubble_plot(input)
p
```

### mix
```{r fig.width=15}
input <- dat %>% filter(exposure_cat %in% c('eye_hearing_teeth')) 
p<-plot_bubble_plot(input)
p
```


## mix
```{r fig.width=15}
input <- dat %>% filter(exposure_cat %in% c('heart_blood_related')) %>% filter(!grepl('transferase', exposure.trait))
p<-plot_bubble_plot(input)
p
```

```{r }
ply<-plotly::ggplotly(p)
ply
```

